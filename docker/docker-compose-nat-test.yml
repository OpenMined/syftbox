# Docker Compose for NAT traversal testing
# Topology:
#   net-alice: alice + server + minio + turn
#   net-bob:   bob + server + minio + turn
#
# Alice and Bob are on DIFFERENT networks and cannot directly reach each other.
# WebRTC must use TURN relay (via coturn) to establish P2P data channels.
# Server bridges both networks for WS signaling.

services:
  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: nat-minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ':9001'
    networks:
      - net-alice
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  turn:
    image: coturn/coturn:latest
    container_name: nat-turn
    command: >
      turnserver
      --no-tls
      --no-dtls
      --realm=syftbox
      --user=syftbox:syftbox
      --listening-port=3478
      --min-port=49152
      --max-port=49200
      --verbose
      --no-multicast-peers
    networks:
      - net-alice
      - net-bob
    healthcheck:
      test: ["CMD-SHELL", "turnutils_uclient -T -p 3478 127.0.0.1 2>&1 | grep -q 'Total' || exit 0"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 3s

  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    container_name: nat-server
    environment:
      - SYFTBOX_ENV=DEV
      - SYFTBOX_AUTH_ENABLED=0
      - SYFTBOX_EMAIL_ENABLED=0
      - SYFTBOX_BLOB_REGION=us-east-1
      - SYFTBOX_BLOB_BUCKET_NAME=syftbox-local
      - SYFTBOX_BLOB_ENDPOINT=http://minio:9000
      - SYFTBOX_BLOB_ACCESS_KEY=ptSLdKiwOi2LYQFZYEZ6
      - SYFTBOX_BLOB_SECRET_KEY=GMDvYrAhWDkB2DyFMn8gU8I8Bg0fT3JGT6iEB7P8
      - SYFTBOX_HTTP_ADDR=0.0.0.0:8080
      - SYFTBOX_HTTP_DOMAIN=server
    networks:
      - net-alice
      - net-bob
    depends_on:
      minio:
        condition: service_healthy
    command: >
      sh -c "
        until mc alias set local http://minio:9000 minioadmin minioadmin >/dev/null 2>&1; do
          echo 'Waiting for MinIO...'
          sleep 1
        done
        sed 's|http://localhost:9000|http://minio:9000|g' /etc/minio/init.d/setup.sh > /tmp/setup.sh
        chmod +x /tmp/setup.sh
        /tmp/setup.sh || true
        echo 'Starting server...'
        ./server
      "
    volumes:
      - ../minio/init.d:/etc/minio/init.d:ro

  alice:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client.rust
    container_name: nat-alice
    environment:
      - SYFTBOX_EMAIL=alice@example.com
      - SYFTBOX_SERVER_URL=http://server:8080
      - SYFTBOX_HOTLINK=1
      - SYFTBOX_HOTLINK_ICE_SERVERS=turn:turn:3478?transport=udp
      - SYFTBOX_HOTLINK_TURN_USER=syftbox
      - SYFTBOX_HOTLINK_TURN_PASS=syftbox
      - SYFTBOX_HOTLINK_DEBUG=1
      - SYFTBOX_HOTLINK_TCP_PROXY=1
      - SYFTBOX_PRIORITY_DEBOUNCE_MS=0
      - SYFTBOX_ACL_STAGING_GRACE_MS=0
    networks:
      - net-alice
    depends_on:
      - server
      - turn

  bob:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client.rust
    container_name: nat-bob
    environment:
      - SYFTBOX_EMAIL=bob@example.com
      - SYFTBOX_SERVER_URL=http://server:8080
      - SYFTBOX_HOTLINK=1
      - SYFTBOX_HOTLINK_ICE_SERVERS=turn:turn:3478?transport=udp
      - SYFTBOX_HOTLINK_TURN_USER=syftbox
      - SYFTBOX_HOTLINK_TURN_PASS=syftbox
      - SYFTBOX_HOTLINK_DEBUG=1
      - SYFTBOX_HOTLINK_TCP_PROXY=1
      - SYFTBOX_PRIORITY_DEBOUNCE_MS=0
      - SYFTBOX_ACL_STAGING_GRACE_MS=0
    networks:
      - net-bob
    depends_on:
      - server
      - turn

networks:
  net-alice:
    driver: bridge
    internal: false
  net-bob:
    driver: bridge
    internal: false
